import { useEffect, useMemo, useState } from "react";
import { NavLink, Link } from "react-router-dom";
import { isPlatformOwner } from "../lib/roles";
import { supabase } from "../lib/supabaseClient";

export default function Dashboard({ user }) {
  const [memberships, setMemberships] = useState([]);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState("");

  // Core overview
  const [todaySessions, setTodaySessions] = useState({ draft: 0, active: 0, completed: 0 });
  const [attemptsToday, setAttemptsToday] = useState(0);
  const [rosterCompletion, setRosterCompletion] = useState({ total: 0, completed: 0, inProgress: 0, notStarted: 0 });

  // Upcoming & Active
  const [upcoming, setUpcoming] = useState([]);
  const [active, setActive] = useState([]);

  const platformOwner = isPlatformOwner(user);
  const canManage = useMemo(() => {
    const roles = memberships.map(m => String(m.role || '').toLowerCase());
    return platformOwner || roles.includes('admin') || roles.includes('superadmin');
  }, [memberships, platformOwner]);

  useEffect(() => {
    let ignore = false;
    const load = async () => {
      if (!user?.id) return;
      setLoading(true);
      try {
        const { data: mem } = await supabase
          .from('memberships')
          .select('role, school_id, schools!inner(name)')
          .eq('user_id', user.id);
        if (ignore) return;
        setMemberships(mem || []);
      } catch (e) {
        if (!ignore) setErr(e?.message || 'Failed to load memberships');
      } finally {
        if (!ignore) setLoading(false);
      }
    };
    load();
    return () => { ignore = true };
  }, [user?.id]);

  useEffect(() => {
    let ignore = false;
    async function loadDashboardData() {
      if (!memberships.length) return;
      const schoolId = memberships[0].school_id; // primary membership for scope
      try {
        // Today window (local day)
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
        const startISO = start.toISOString();
        const endISO = end.toISOString();

        // Sessions by status for today
        const { data: sessDraft } = await supabase
          .from('sessions')
          .select('id')
          .eq('school_id', schoolId)
          .eq('status', 'draft')
          .gte('session_date', startISO)
          .lt('session_date', endISO);
        const { data: sessActive } = await supabase
          .from('sessions')
          .select('id')
          .eq('school_id', schoolId)
          .eq('status', 'active')
          .gte('session_date', startISO)
          .lt('session_date', endISO);
        const { data: sessCompleted } = await supabase
          .from('sessions')
          .select('id')
          .eq('school_id', schoolId)
          .eq('status', 'completed')
          .gte('session_date', startISO)
          .lt('session_date', endISO);
        if (ignore) return;
        setTodaySessions({
          draft: (sessDraft || []).length,
          active: (sessActive || []).length,
          completed: (sessCompleted || []).length,
        });

        // Attempts recorded today
        const { data: attempts } = await supabase
          .from('scores')
          .select('id, updated_at, session_id, sessions!inner(school_id)')
          .gte('updated_at', startISO)
          .lt('updated_at', endISO);
        const countToday = (attempts || []).filter(r => r.sessions?.school_id === schoolId).length;
        if (ignore) return;
        setAttemptsToday(countToday);

        // Upcoming (next 7 days) and currently active sessions list
        const horizonEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 7).toISOString();
        const { data: upc } = await supabase
          .from('sessions')
          .select('id,title,session_date,status')
          .eq('school_id', schoolId)
          .gt('session_date', endISO)
          .lt('session_date', horizonEnd)
          .order('session_date', { ascending: true });
        const { data: act } = await supabase
          .from('sessions')
          .select('id,title,session_date,status')
          .eq('school_id', schoolId)
          .eq('status', 'active')
          .order('session_date', { ascending: true });
        if (ignore) return;
        setUpcoming(upc || []);
        setActive(act || []);

        // Simple completion snapshot: last active session roster vs completed
        if ((act || []).length > 0) {
          const sid = act[0].id;
          const { data: rosterRows } = await supabase
            .from('session_roster')
            .select('student_id')
            .eq('session_id', sid);
          const rosterIds = new Set((rosterRows || []).map(r => r.student_id));
          const { data: scoreRows } = await supabase
            .from('scores')
            .select('student_id, situps, shuttle_run, sit_and_reach, pullups, broad_jump')
            .eq('session_id', sid);
          const required = ['situps','shuttle_run','sit_and_reach','pullups','broad_jump'];
          let completed = 0, inProg = 0, notStarted = 0;
          rosterIds.forEach(id => {
            const row = (scoreRows || []).find(x => x.student_id === id);
            if (!row) { notStarted++; return; }
            const nonNull = required.reduce((a,k)=>a+(row[k]==null?0:1),0);
            if (nonNull === 0) notStarted++;
            else if (nonNull === required.length) completed++;
            else inProg++;
          });
          setRosterCompletion({ total: rosterIds.size, completed, inProgress: inProg, notStarted });
        } else {
          setRosterCompletion({ total: 0, completed: 0, inProgress: 0, notStarted: 0 });
        }
      } catch (e) {
        setErr(e?.message || 'Failed to load dashboard data');
      }
    }
    loadDashboardData();
    return () => { ignore = true };
  }, [memberships]);

  const kpi = (label, value, sub) => (
    <div className="rounded-xl bg-white p-4 shadow-sm border border-gray-100">
      <div className="text-sm text-gray-500">{label}</div>
      <div className="mt-1 text-2xl font-semibold text-slate-900">{value}</div>
      {sub ? <div className="text-sm text-gray-500 mt-1">{sub}</div> : null}
    </div>
  );

  return (
    <div className="bg-[#F9FAFB]">
      <div className="max-w-6xl mx-auto px-4 py-6 space-y-8">
        {/* Header */}
        <div className="flex items-center gap-3">
          <img src="/icon.png" alt="NAPFA 5" className="w-8 h-8" />
          <div>
            <h1 className="text-3xl font-semibold tracking-tight text-slate-900">Dashboard</h1>
            <div className="text-sm text-slate-600">Welcome back{user?.email ? `, ${user.email}` : ''}.</div>
          </div>
        </div>

        {err && (
          <div className="rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-700">{err}</div>
        )}

        {/* Core Overview */}
        <section>
          <h2 className="text-xl font-semibold text-slate-900 mb-3">Core Overview</h2>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            {kpi('Today: Draft Sessions', todaySessions.draft)}
            {kpi('Today: Active Sessions', todaySessions.active)}
            {kpi('Today: Completed Sessions', todaySessions.completed)}
            {kpi('Attempts Recorded (today)', attemptsToday)}
          </div>
          <div className="mt-3 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="rounded-xl bg-white p-4 shadow-sm border border-gray-100">
              <div className="text-sm text-gray-500">Not started</div>
              <div className="mt-1 text-2xl font-semibold text-slate-900">{rosterCompletion.notStarted}</div>
            </div>
            <div className="rounded-xl bg-white p-4 shadow-sm border border-gray-100">
              <div className="text-sm text-gray-500">In progress</div>
              <div className="mt-1 text-2xl font-semibold text-slate-900">{rosterCompletion.inProgress}</div>
            </div>
            <div className="rounded-xl bg-white p-4 shadow-sm border border-gray-100">
              <div className="text-sm text-gray-500">Completed</div>
              <div className="mt-1 text-2xl font-semibold text-slate-900">{rosterCompletion.completed} / {rosterCompletion.total}</div>
            </div>
          </div>
        </section>

        {/* Upcoming & Active */}
        <section>
          <h2 className="text-xl font-semibold text-slate-900 mb-3">Upcoming & Active</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="rounded-xl bg-white p-4 shadow-sm border border-gray-100">
              <div className="flex items-center justify-between mb-2">
                <div className="font-medium">Active Sessions</div>
                <Link to="/sessions" className="text-sm text-blue-700 hover:underline">Manage</Link>
              </div>
              <ul className="divide-y divide-gray-100">
                {(active || []).slice(0,5).map(s => (
                  <li key={s.id} className="py-2 flex items-center justify-between">
                    <Link to={`/session/${s.id}`} className="text-slate-800 hover:underline">{s.title || 'Untitled'}</Link>
                    <span className="text-xs rounded px-2 py-0.5 bg-green-50 text-green-700 border border-green-200">active</span>
                  </li>
                ))}
                {active.length === 0 && <li className="py-2 text-sm text-gray-500">No active sessions</li>}
              </ul>
            </div>
            <div className="rounded-xl bg-white p-4 shadow-sm border border-gray-100">
              <div className="flex items-center justify-between mb-2">
                <div className="font-medium">Upcoming (next 7 days)</div>
                <Link to="/sessions" className="text-sm text-blue-700 hover:underline">View all</Link>
              </div>
              <ul className="divide-y divide-gray-100">
                {(upcoming || []).slice(0,5).map(s => (
                  <li key={s.id} className="py-2 flex items-center justify-between">
                    <span className="text-slate-800">{s.title || 'Untitled'}</span>
                    <span className="text-xs text-gray-500">{new Date(s.session_date).toLocaleDateString()}</span>
                  </li>
                ))}
                {upcoming.length === 0 && <li className="py-2 text-sm text-gray-500">No upcoming sessions</li>}
              </ul>
            </div>
          </div>
        </section>

        {/* Students & Enrollments */}
        <section className="hidden">
          <h2 className="text-xl font-semibold text-slate-900 mb-3">Students & Enrollments</h2>
          <div className="rounded-xl bg-white p-4 shadow-sm border border-gray-100">
            <div className="text-sm text-gray-600">Quick links</div>
            <div className="mt-2 flex flex-wrap gap-2">
              <NavLink to="/manage-students" className="px-3 py-1.5 border rounded hover:bg-gray-50">Manage Students</NavLink>
              <NavLink to="/add-attempt" className="px-3 py-1.5 border rounded hover:bg-gray-50">Open Score Entry</NavLink>
              <NavLink to="/view-score" className="px-3 py-1.5 border rounded hover:bg-gray-50">View Scores</NavLink>
            </div>
          </div>
        </section>

        {/* Insights */}
        <section>
          <h2 className="text-xl font-semibold text-slate-900 mb-3">Insights</h2>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="rounded-xl bg-white p-4 shadow-sm border border-gray-100">
              <div className="text-sm text-gray-500 mb-1">Award mix (last 30 days)</div>
              <div className="text-sm text-gray-400">Coming soon</div>
            </div>
            <div className="rounded-xl bg-white p-4 shadow-sm border border-gray-100">
              <div className="text-sm text-gray-500 mb-1">Station averages</div>
              <div className="text-sm text-gray-400">Coming soon</div>
            </div>
            <div className="rounded-xl bg-white p-4 shadow-sm border border-gray-100">
              <div className="text-sm text-gray-500 mb-1">Throughput</div>
              <div className="text-sm text-gray-400">Coming soon</div>
            </div>
          </div>
        </section>

        {/* Recent Activity & Audit */}
        <section>
          <h2 className="text-xl font-semibold text-slate-900 mb-3">Recent Activity & Audit</h2>
          <div className="rounded-xl bg-white p-4 shadow-sm border border-gray-100">
            <ul className="list-disc pl-5 text-sm text-slate-700 space-y-1">
              <li>Recent score entries and exports will appear here.</li>
              <li>Roster changes (added/removed students) show with timestamps.</li>
              <li>Imports summary and any errors.</li>
            </ul>
          </div>
        </section>

        {/* Help & Shortcuts */}
        <section className="hidden">
          <h2 className="text-xl font-semibold text-slate-900 mb-3">Help & Shortcuts</h2>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
            <Link to="/add-attempt" className="rounded-xl bg-white p-4 shadow-sm border border-gray-100 hover:shadow-md transition">Score Entry</Link>
            <Link to="/sessions" className="rounded-xl bg-white p-4 shadow-sm border border-gray-100 hover:shadow-md transition">Manage Sessions</Link>
            <Link to="/manage-students" className="rounded-xl bg-white p-4 shadow-sm border border-gray-100 hover:shadow-md transition">Manage Students</Link>
            <Link to="/pft-calculator" className="rounded-xl bg-white p-4 shadow-sm border border-gray-100 hover:shadow-md transition">PFT Calculator</Link>
          </div>
        </section>

        {/* Roleâ€‘Specific Widgets */}
        <section>
          <h2 className="text-xl font-semibold text-slate-900 mb-3">Roleâ€‘Specific</h2>
          <div className="rounded-xl bg-white p-4 shadow-sm border border-gray-100 text-sm text-slate-700">
            {platformOwner && <div className="mb-1">Platform Owner: access Global Admin and Schools management.</div>}
            {canManage && <div className="mb-1">Admin: create sessions, edit rosters, manage users/students.</div>}
            {!platformOwner && !canManage && <div>Teacher/Viewer: record attempts and view results for assigned sessions.</div>}
          </div>
        </section>

        {/* What's new */}
        <section>
          <h2 className="text-xl font-semibold text-slate-900 mb-3">Whatâ€™s new</h2>
          <div className="rounded-xl bg-white p-4 shadow-sm border border-gray-100">
            <ul className="list-disc pl-5 text-sm text-slate-700 space-y-1">
              <li>Dual-list roster with filters and pagination.</li>
              <li>Improved PFT export (template header rows, attendance/date logic, per-class files).</li>
              <li>Profile cards PDF with footer bands and class page breaks.</li>
              <li>Live station validation and auto-select session when only one.</li>
              <li>Homepage redesign with premium hero and animations.</li>
            </ul>
          </div>
        </section>
      </div>
    </div>
  );
}
